---
- name: Bootstrap k3s
  hosts: all
  become: true
  gather_facts: true
  any_errors_fatal: true
  vars:
    base_dir: "/opt/k8s"
    repo_local_dir: "home-ops"
    key_dir: "keys"
    gitkey: "gitkey_ed25519"
    agekey: "keys.txt"

  tasks:
    - name: Load encrypted vars
      community.sops.load_vars:
        file: vars.sops.yaml
        expressions: ignore
    - name: Create base directory
      file:
        path: "{{ base_dir }}/{{ item }}"
        state: directory
      loop:
        - "{{  repo_local_dir }}"
        - "{{  key_dir }}"
    - name: Copy ssh key
      copy:
        src: "{{ '/home/' + ansible_user }}/.ssh/{{ gitkey }}"
        dest: "{{ base_dir }}/{{ key_dir }}/{{ gitkey }}"
        mode: 0400
    - name: Copy age key
      copy:
        src: "{{ '/home/' + ansible_user }}/.config/sops/age/server_keys.txt"
        dest: "{{ base_dir }}/{{ key_dir }}/{{ agekey }}"
        mode: 0400
    - name: "Bootstrap :: Ensure repo is checked out"
      ansible.builtin.git:
        accept_newhostkey: true
        repo: "ssh://git@gitea.carbon.{{ root_domain }}:2222/gitea_admin/home-ops.git"

        dest: "{{ base_dir }}/{{ repo_local_dir }}"
        key_file: "{{ base_dir }}/{{ key_dir }}/{{ gitkey }}"
        version: "main"

    # "TODO: avoid using shell"
    - name: "Bootstrap :: Run Flux install"
      ansible.builtin.shell:
        cmd: "kubectl apply --server-side --kustomize ./kubernetes/bootstrap/flux"
        chdir: "{{ base_dir }}/{{ repo_local_dir }}"

    - name: "Bootstrap :: Install secrets"
      ansible.builtin.shell:
        cmd: "sops --decrypt {{ item }} | kubectl apply -f -"
        chdir: "{{ base_dir }}/{{ repo_local_dir }}"
      environment:
        SOPS_AGE_KEY_FILE: "{{ base_dir }}/{{ key_dir }}/{{ agekey }}"
      loop:
        - "kubernetes/bootstrap/flux/age-key.sops.yaml"
        - "kubernetes/bootstrap/flux/gitea-deploy-key.sops.yaml"
        - "kubernetes/flux/vars/cluster-secrets.sops.yaml"
    - name: "Bootstrap :: Apply cluster settings"
      ansible.builtin.shell:
        cmd: "kubectl apply -f kubernetes/flux/vars/cluster-settings.yaml"
        chdir: "{{ base_dir }}/{{ repo_local_dir }}"
    - name: "Bootstrap :: Run initial flux manifests"
      ansible.builtin.shell:
        cmd: "kubectl apply --server-side --kustomize ./kubernetes/flux/config"
        chdir: "{{ base_dir }}/{{ repo_local_dir }}"
